{% extends "teacher/base_course.html" %}

{% block title %}{{ course.course_code }} - Outcome Ağırlıkları{% endblock %}

{% block extra_head %}
<style>
  .page-title{ font-weight: 800; margin: 0 0 6px; }
  .muted{ color:#666; margin-bottom: 16px; }

  .cardx{
    border: 1px solid #eee;
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    background: #fff;
  }

  .tablex{ width:100%; border-collapse: collapse; margin-top: 10px; }
  .tablex th, .tablex td{ border: 1px solid #e5e5e5; padding: 10px; }
  .tablex th{ background:#f7f7f7; }

  .w-input{
    width: 120px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 8px 10px;
  }

  .btn-save{
    background:#0d6efd;
    color:#fff;
    border:0;
    border-radius: 10px;
    padding: 9px 14px;
    cursor:pointer;
    font-weight: 800;
  }
  .btn-save:hover{ filter: brightness(0.95); }

  .acc-btn{
    width:100%;
    text-align:left;
    background:#f6f8ff;
    border: 1px solid #dfe7ff;
    border-radius: 12px;
    padding: 12px 14px;
    font-weight: 800;
    cursor:pointer;
    display:flex;
    justify-content: space-between;
    align-items:center;
  }
  .acc-body{
    border: 1px solid #eee;
    border-radius: 12px;
    margin-top: 10px;
    padding: 12px;
    background:#fff;
  }
  .chip{
    display:inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    background:#fff;
    border: 1px solid #e8e8e8;
    color:#333;
    font-size: 12px;
    font-weight: 700;
  }
</style>
{% endblock %}

{% block content %}
  <div class="cardx">
    <h3 class="page-title">Outcome Ağırlıkları</h3>
    <div class="muted">
      Her değerlendirme bileşeni (vize/final vb.) için learning outcome ağırlıklarını girin.
    </div>

    {% if not course_data %}
      <div class="text-muted">Veri bulunamadı.</div>
    {% else %}

      {# course_data list geliyor ama biz tek ders bekliyoruz; ilk elemanı alıyoruz #}
      {% with c=course_data.0 %}
        {% if not c.component_data %}
          <div class="text-muted">Bu derse ait bileşen bulunamadı.</div>
        {% elif not c.outcomes %}
          <div class="text-muted">Bu derse ait learning outcome bulunamadı.</div>
        {% else %}

          {% for block in c.component_data %}
            <div style="margin-bottom:14px;">
              <button class="acc-btn" type="button" onclick="toggleAcc('acc_{{ block.component.id }}')">
                <span>{{ block.component.name }} <span class="chip">%{{ block.component.percentage }}</span></span>
                <span id="ico_acc_{{ block.component.id }}">+</span>
              </button>

              <div id="acc_{{ block.component.id }}" class="acc-body" style="display:none;">
                <form method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="component_id" value="{{ block.component.id }}">

                  <table class="tablex">
                    <thead>
                      <tr>
                        <th style="width:70%;">Learning Outcome</th>
                        <th style="width:30%;">Ağırlık</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in block.outcome_rows %}
                        <tr>
                          <td>{{ row.outcome.description }}</td>
                          <td>
                            <input
                              class="w-input"
                              type="number"
                              min="0"
                              step="1"
                              name="weight_{{ block.component.id }}_{{ row.outcome.id }}"
                              value="{% if row.weight is not None %}{{ row.weight }}{% endif %}"
                              placeholder="örn: 20"
                            >
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>

                  <div style="display:flex; justify-content:flex-end; margin-top:12px;">
                    <button class="btn-save" type="submit">Kaydet</button>
                  </div>
                </form>
              </div>
            </div>
          {% endfor %}

        {% endif %}
      {% endwith %}
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
<script>
  function toggleAcc(id){
    const el = document.getElementById(id);
    const ico = document.getElementById("ico_" + id);
    if(!el) return;
    const isOpen = el.style.display === "block";
    el.style.display = isOpen ? "none" : "block";
    if(ico) ico.textContent = isOpen ? "+" : "−";
  }
</script>
{% endblock %}
