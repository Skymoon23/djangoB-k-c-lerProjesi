{% extends "headteacher/base_headteacher.html" %}

{% block title %}LO–PO Ağırlıklarını Yönet | ALMS University{% endblock %}

{% block extra_head %}
<style>
    .page-title {
        font-weight: 800;
        color: #0b2a4a;
    }

    /* Ana Kart Tasarımı */
    .card-main {
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
        border: none;
        background: #ffffff;
        margin-bottom: 30px;
        padding: 20px;
    }

    /* Ders Kartları (Accordion) */
    .course-accordion-card {
        border-radius: 16px !important;
        border: 1px solid #eef2ff !important;
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .course-accordion-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .card-header {
        background: #ffffff !important;
        padding: 20px 25px !important;
        border-bottom: none !important;
        cursor: pointer;
    }

    /* Rozetler (Badges) */
    .badge-course {
        background: #e0f2fe;
        color: #0369a1;
        font-weight: 800;
        padding: 6px 12px;
        border-radius: 8px;
    }

    .badge-outcome {
        background: #f1f5f9;
        color: #475569;
        font-weight: 700;
        padding: 8px 14px;
        border-radius: 10px;
        font-size: 0.9rem;
        border: 1px solid #e2e8f0;
    }

    /* Detay Butonu */
    .toggle-btn {
        background-color: #f8fafc;
        border: 1.5px solid #e2e8f0;
        color: #64748b;
        font-weight: 700;
        border-radius: 12px;
        padding: 8px 18px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        transition: all 0.2s;
    }

    .toggle-btn:hover, .toggle-btn:not(.collapsed) {
        background-color: #2563eb;
        color: #ffffff;
        border-color: #2563eb;
    }

    /* Tablo Tasarımı */
    .table-weight thead th {
        background: #f8fafc;
        color: #64748b;
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 15px;
        border: none;
    }

    .table-weight td {
        padding: 12px 15px;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
    }

    /* Form Elemanları */
    .form-select-sm {
        border-radius: 8px;
        border: 1.5px solid #e2e8f0;
        font-weight: 600;
        color: #0b2a4a;
    }

    .form-select-sm:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* LO Başlık Alanı */
    .lo-header-box {
        background: #ffffff;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .save-status {
        font-weight: 700;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="card-main">
        <h2 class="page-title mb-2">LO–PO Ağırlık Yönetimi</h2>
        <p class="text-muted mb-0">
            Her dersin <strong>Öğrenme Çıktısı (LO)</strong> ile <strong>Program Çıktısı (PO)</strong> arasındaki ilişki düzeyini (1-5) belirleyin.
        </p>
    </div>

    {% for course_item in course_data %}
    <div class="card course-accordion-card shadow-sm">
        <div class="card-header" id="manageHeading{{ forloop.counter }}">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <span class="badge-course">{{ course_item.course.course_code }}</span>
                    <h5 class="mb-0 fw-bold text-dark">{{ course_item.course.course_name }}</h5>
                </div>
                <button class="toggle-btn collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#manageCollapse{{ forloop.counter }}"
                        aria-expanded="false">
                    <span>Detayları Gör</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
        </div>

        <div id="manageCollapse{{ forloop.counter }}" class="collapse">
            <div class="card-body bg-light-subtle px-4">
                {% if course_item.outcome_data %}
                    {% for outcome_item in course_item.outcome_data %}
                    <div class="lo-header-box border mb-4">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge-outcome">
                                    <i class="bi bi-bullseye text-primary me-2"></i>{{ outcome_item.outcome.description|truncatewords:10 }}
                                </span>
                                <small class="text-muted fw-bold">LO-{{ outcome_item.outcome.id }}</small>
                            </div>

                            <div class="d-flex gap-2">
                                <a href="{% url 'edit_learning_outcome' outcome_item.outcome.id %}" class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                    <i class="bi bi-pencil-square"></i> Düzenle
                                </a>
                                <form method="post" action="{% url 'delete_learning_outcome' outcome_item.outcome.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-sm btn-outline-danger rounded-pill px-3" onclick="event.preventDefault(); const form = this.closest('form'); customConfirm('Silmek istediğinize emin misiniz?').then(ok => { if(ok) form.submit(); });">
                                        <i class="bi bi-trash3"></i> Sil
                                    </button>
                                </form>
                            </div>
                        </div>

                        <form method="post" class="mt-4 weight-form" data-outcome-id="{{ outcome_item.outcome.id }}">
                            {% csrf_token %}
                            <input type="hidden" name="outcome_id" value="{{ outcome_item.outcome.id }}">

                            <div class="table-responsive bg-white rounded-4 border">
                                <table class="table table-weight table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Program Outcome (PO)</th>
                                            <th>Açıklama</th>
                                            <th class="text-center" style="width: 180px;">Ağırlık (1-5)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in outcome_item.po_rows %}
                                        <tr>
                                            <td class="fw-bold text-primary">{{ row.program_outcome.code }}</td>
                                            <td class="text-muted small">{{ row.program_outcome.description|truncatewords:15 }}</td>
                                            <td>
                                                <select name="weight_{{ outcome_item.outcome.id }}_{{ row.program_outcome.id }}"
                                                        class="form-select form-select-sm">
                                                    <option value="" {% if not row.weight %}selected{% endif %}>- Seç -</option>
                                                    {% for i in "12345" %}
                                                        <option value="{{ i }}" {% if row.weight|stringformat:"s" == i %}selected{% endif %}>{{ i }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-3 d-flex align-items-center gap-3">
                                <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold shadow-sm">
                                    <i class="bi bi-cloud-check-fill me-2"></i> Ağırlıkları Kaydet
                                </button>
                                <span class="save-status" style="display: none;"></span>
                            </div>
                        </form>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted italic mb-0">Bu ders için henüz öğrenme çıktısı tanımlanmamış.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-5">
        <i class="bi bi-clipboard-x fs-1 text-muted"></i>
        <p class="text-muted mt-3">Sistemde henüz ders bulunmamaktadır.</p>
    </div>
    {% endfor %}

</div>
{% endblock %}

{% block extra_js %}
<script>
// Mevcut AJAX script'iniz aynen korunmuştur, görsel yapıyla uyumludur.
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.weight-form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const statusSpan = form.querySelector('.save-status');

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> İşleniyor...';

            fetch(form.action || window.location.href, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusSpan.innerHTML = '<i class="bi bi-check-circle-fill"></i> ' + data.message;
                    statusSpan.className = 'save-status text-success';
                    statusSpan.style.display = 'inline';
                    setTimeout(() => { statusSpan.style.fadeOut = 'slow'; statusSpan.style.display = 'none'; }, 3000);
                }
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="bi bi-cloud-check-fill me-2"></i> Ağırlıkları Kaydet';
            });
        });
    });
});
</script>
{% endblock %}